# Caminho: ./volumes/logs/vector.yaml

# --- Fontes (Inputs) ---
sources:
  docker_logs:
    type: "docker_logs"
    exclude_containers:
      - "supabase-vector-global"

# --- Transformações ---
transforms:
  filter_global_services:
    type: "filter"
    inputs:
      - "docker_logs"
    # Filtra e permite passar APENAS os logs dos seus serviços globais
    condition: >-
      includes([
        "supabase-db",
        "supabase-pooler",
        "realtime-dev.supabase-realtime",
        "supabase-edge-functions",
        "docker-projects-api-1",
        "traefik-traefik-1"
      ], .container_name)

# --- Saídas ---
sinks:
  postgresql_logs:
    type: "postgres"
    # Recebe os logs JÁ FILTRADOS
    inputs:
      - "filter_global_services"
    # Pega a URI do banco do seu docker-compose.yml
    endpoint: "${PG_URI}"
    # Nome da tabela no banco 'logs_db'
    table: "public.logs"
    batch:
      max_events: 100
      timeout_secs: 1
    # encoding:
    #   # Salva o log inteiro como um objeto JSON
    #   codec: "json"
    #   # Remove campos desnecessários
    #   except_fields:
    #     - "source_type"